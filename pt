#!/bin/sh

set -e

dmenu=false
fzf=false

N='\033[0m'       # Text Reset
R='\033[0;91m'    # Red
G='\033[0;92m'    # Green
Y='\033[0;93m'    # Yellow
W='\033[0;97m'    # White

download_dir="$HOME/.pt"
version="dev 2.0"

sname="$(basename $0)"

show_help(){
    printf "
    ${Y}Usage:${N}  ${G}$sname${N} ${W}[ -q ARG ] [ -l ARG ] [vfdm]${N}

         ${Y}-q${N}  For the search query !
               Example: ${G}$sname${N} -q hallo

         ${Y}-l${N}  To add a language code
               Example  ${G}$sname${N} -l en -q hello

         ${Y}-d${N}  To download the audios and store them locally.
                
                * For each query a folder will be created and store all the audios inside it !
                * Support offline usage. 

         ${Y}-v${N}  Show version

         ${Y}-m${N}  To use dmenu

         ${Y}-f${N}  To use fzf

         (${G}-d${N}) For ${W}offline${N} ${Y}Usage:${N}

             The script will create a directory located at ${W}${download_dir}/LangCode/SomeQuery${N}

"
}

getsource(){

    trap cleanup INT QUIT TERM EXIT


    cleanup(){
        [ -f $tmpfile ] && rm $tmpfile
    }

    curl -s "https://${lang:=en}.wiktionary.org/wiki/${query}" | \
        grep -Eo '//upload[a-zA-Z0-9./?=_%:-]*\.+(ogg|mp3|wav|aac)' | sort -u | \
        grep $(printf ${lang:=en} | sed -e 's/^\(.\)/\U\1/g') | \
        sed 's/\/\//https:&/g' >$tmpfile 
}

show_version(){
        printf "${G}$sname${N} ${W}Version:${N} ${Y}%s${N}\n" "$version"
        exit 0
}


check_dep(){
    if ! command -v "$1";then
        printf "${R}$1 is not installed !${N}\n" && exit 127
    fi
}

_main_(){

    query=$(printf "$query" | tr -d ' ')
    tmpfile=`mktemp`
    aud_dir="${download_dir}/${lang:=en}/${query}"

    if ls -A "$aud_dir" 2> /dev/null;then # check if a dir is not empty instead of existance
        selected=$(ls "$aud_dir" | $1)
        mpv --quiet "${aud_dir}/${selected}"
        exit 0
    else
        getsource
        if [ -s $tmpfile ];then
            selected=$(rev $tmpfile | cut -d'/' -f 1 | rev | $1)
            grep $selected $tmpfile | mpv --quiet --playlist=-
            [ $download ] && download_aud
	    exit 0
        else
	        error
        fi
    fi
}

error(){
	printf "No audio files found for $query \nLanguage code Used : ${lang:=en}\n"
	exit 1
}

download_aud(){
    mkdir -p "${aud_dir}" 
    printf "${G}Downloading the audios ...${N}\n"
    cat $tmpfile | parallel curl -s -O --output-dir "${aud_dir}" && printf "${G}Download completed.${N}\n" \
        || (printf "${R}Enable to download the audio files !${N}\n" && exit 1)
}

while getopts "q:hl:dfmv" OPT; do
    case "$OPT" in 
        h) show_help && exit 0 ;; 
        q) query=$OPTARG ;;
        l) lang=$OPTARG ;;
        f) fzf=true;;
        d) download=true ;;
        m) dmenu=true ;;
        v) show_version ;;
        *) printf "${R}Wrong usage !${N}\n Show help with: ${G}$sname${N} ${W}-h${N} \n" >&2 && exit 1;;
    esac
done

# If the query is empty or is not a casual word
if ! expr "$query" : "[a-zA-Z]" 1>/dev/null; then
    printf "${R}Error:${N} The ${W}query${N} must be a non empty letter !\n" >&2  
    exit 1
fi

[ $dmenu = "true" ] && [ $fzf = "true" ] && \
    printf "${R}Error:${N} ${W}-m${N} and ${W}-f${N} are mutually exclusive and may only be used once\n" >&2 && exit 2


if $dmenu;then
    check_dep dmenu
     _main_ "dmenu -l 10"
elif $fzf
then
    check_dep fzf 
    _main_ "fzf --reverse --height=40%"
else
    _main_ "head -n 1"
fi
